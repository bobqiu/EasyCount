[system]


sql=with \
(select 0 tag, uin, collect_set(touin) uins, from_unixtime(AGGRTIME DIV 1000, "yyyyMMdd") day, AGGRTIME agtime from tbl_jiahaoyou \
group by uin coordinate by dTime with aggr interval 300 seconds) tmp, \
\
(select 1 tag, uin, array('') uins, from_unixtime(AGGRTIME DIV 1000, "yyyyMMdd") day, max(inserttime) maxitime, AGGRTIME agtime \
from tbl_trigger group by uin coordinate by dTime with aggr interval 3600 seconds) tmp1, \
\
(select tag, uin, day, if(tag=0, foreach(k of dim.uinall generate if($k=day, array_merge(map_get(dim.uinall, $k), uniontmp.uins), \
map_get(dim.uinall, $k))), dim.uinall) newuinall from (select tag, uin, uins, day, agtime from tmp union all select tag, uin, uins, day, agtime \
from tmp1 where agtime+3600000L-maxitime>6*3600*1000L) uniontmp left join dim_hbase dim on uniontmp.uin=dim.uin) tmp3 \
\
insert into dim_hbase with uin as key select uin, day, newuinall from tmp3, \
\
insert into tde_res select uin, day, \
array_sum(foreach(k of newuinall generate if(unix_timestamp()-unix_timestamp($k, 'yyyyMMdd')<=30*24*60*60L, map_get(newuinall, $k),null))) from tmp3, \
\
insert into tbl_trigger select uin, inserttime, unix_timestamp()*1000+30*60*1000L dTime from (select uin, maxitime inserttime \
from tmp1 where agtime+3600000L-maxitime>=6*3600*1000L union all select uin, unix_timestamp() inserttime from tmp3) xxx


sql1=with \
(select 0 tag, uin, collect_set(touin) uins, from_unixtime(AGGRTIME DIV 1000, "yyyyMMdd") day, AGGRTIME agtime from tbl_jiahaoyou \
group by uin coordinate by dTime with aggr interval 300 seconds) tmp, \
\
(select 1 tag, uin, array('') uins, from_unixtime(AGGRTIME DIV 1000, "yyyyMMdd") day, max(inserttime) maxitime, AGGRTIME agtime \
from tbl_trigger group by uin coordinate by dTime with aggr interval 3600 seconds) tmp1, \
\
(select tag, uin, day, if(tag=0, null, dim.uinall) newuinall from (select tag, uin, uins, day, agtime from tmp union all select tag, uin, uins, day, agtime \
from tmp1 where agtime+3600000L-maxitime>6*3600*1000L) uniontmp left join dim_hbase dim on uniontmp.uin=dim.uin) tmp3 \
\
insert into dim_hbase with uin as key select uin, day, newuinall from tmp3, \
\
insert into tde_res with uin as key select uin, day, 1000L from tmp3, \
\
insert into tbl_trigger select uin, inserttime, unix_timestamp()*1000+30*60*1000L dTime from (select uin, maxitime inserttime \
from tmp1 where agtime+3600000L-maxitime>=6*3600*1000L union all select uin, unix_timestamp() inserttime from tmp3) xxx






[tabledesc-tbl_jiahaoyou]
table.name=tbl_jiahaoyou
table.fields=uin,string,:touin,string,:dTime,bigint,
table.zk.root=/meta_vip
table.topic=hy_happygame
table.interfaceId=tbl_jiahaoyou
table.field.splitter=|

[tabledesc-tbl_trigger]
table.name=tbl_trigger
table.fields=uin,string,:inserttime,bigint,:dTime,bigint,
table.zk.servers=tl-zk-td1:2181,tl-zk-td2:2181,tl-zk-td3:2181,tl-zk-td4:2181,tl-zk-td5:2181
table.zk.root=/meta_vip
table.topic=hy_happygame
table.interfaceId=tbl_trigger
table.field.splitter=|

[tabledesc-dim-dim_hbase]
table.type=tde
table.name=dim_hbase
table.fields=uin,string,:day,string,:uinall,map<string\\,array<string>>,
table.field.key=uin
table.binary.mode=true

table.tde.master=10.224.152.35:5198
table.tde.slave=10.129.131.235:5198
table.tde.groupname=tde_test
table.tde.tid=902
table.tde.timeout=5000

[tabledesc-dim-tde_res]
table.type=redis
table.name=tde_res
table.fields=uin,string,:day,string,:num,bigint,
table.field.key=k
table.binary.mode=true

table.field.splitter=,
table.list.splitter=;
table.map.splitter=:

table.redis.host=127.0.0.1
table.redis.port=6379







