[system]
sql=with \
(select 0 tag, substr(GameID_,3,16) gameId, Uin_ uin, cast(null as bigint) op, TimeStamp_ ts from log_10527 union all \
select 1 tag, substr(GameID_,3,16) gameId, cast(null as bigint) uin, OP_ op, TimeStamp_ ts from log_10528) tmp \
\
insert into wx_auth_log with concat_ws("-", gameId, from_unixtime(AGGRTIME DIV 1000, "yyyyMMddHHmm"), "0") as key \
select concat_ws("-", gameId, from_unixtime(AGGRTIME DIV 1000, "yyyyMMddHHmm"), "0"), \
map("pv", count(uin), "allow", count(if(tag=0, null, if(op=1, 1, null))), \
"cancel", count(if(tag=0, null, if(op=2, 1, null)))) info from tmp \
group by gameId coordinate by ts*1000 with aggr interval 300 seconds \
\
with (select substr(appid_,3,16) appid_, Action_, TimeStamp_ from log_10978) parse_10978 \
\
insert into wx_auth_log with concat_ws("-", appid_, from_unixtime(AGGRTIME DIV 1000, "yyyyMMddHHmm"), "1") as key \
select concat_ws("-", appid_, from_unixtime(AGGRTIME DIV 1000, "yyyyMMddHHmm"), "1"), \
map("pv", count(if (Action_='scan', 1, null)), "allow", count(if (Action_='allow', 1, null)), \
"cancel", count(if (Action_='cancel', 1, null))) info from parse_10978 group by appid_ coordinate by TimeStamp_*1000 \
with aggr interval 300 seconds \
\
insert into auth_record select from_unixtime(AGGRTIME DIV 1000, "yyyyMMddHHmm"), appid_, flag from \
(select 0 flag, gameId appid_ from tmp union all select 1 flag, appid_ from parse_10978) uniontbl \
group by appid_, flag coordinate by unix_timestamp()*1000 with aggr interval 300 seconds 

[tabledesc-res-wx_auth_log]
table.type=hbase
table.name=wx_auth_log
table.fields=rowkey,string,:info,map<string\\,bigint>,

table.hbase.zk.quorum=10.196.128.108,10.196.128.109,10.196.128.110,10.196.128.111,10.196.128.112
table.hbase.zk.port=2181
table.hbase.zk.root=/hbase
table.hbase.read.async=true
table.hbase.write.async=true

table.field.splitter=,
table.list.splitter=;
table.map.splitter=:

[tabledesc-res-auth_record]
table.name=auth_record
table.type=mysql
table.fields=time,string,:appid,string,:record_type,int,
table.field.splitter=,
table.list.splitter=;
table.map.splitter=:

table.mysql.db.host=10.156.8.48
table.mysql.db.port=3306
table.mysql.db.name=wxauth_monitor
table.mysql.db.username=qspace
table.mysql.db.passwd=forconnect

[tabledesc-log-10527]
table.name=log_10527
table.binary.mode=false
table.fields=LogID_,BIGINT,:ProtocolVersion_,BIGINT,:Uin_,BIGINT,:IfSuccess_,BIGINT,:Device_,BIGINT,:ClientVersion_,BIGINT,:ClientIP_,BIGINT,:AgentIP_,BIGINT,:TimeStamp_,BIGINT,:ExpandCol1_,BIGINT,:ExpandCol2_,BIGINT,:GameID_,STRING,:GameVer_,BIGINT,:Ret_,BIGINT,
table.field.splitter=,
table.list.splitter=;
table.map.splitter=:
table.zk.servers=tl-zk-wx1:2181,tl-zk-wx2:2181,tl-zk-wx3:2181,tl-zk-wx4:2181,tl-zk-wx5:2181
table.zk.root=/meta_weixin
table.topic=wxg_weixin_msg_oauth
table.interfaceId=10527

[tabledesc-log-10528]
table.name=log_10528
table.binary.mode=false
table.fields=LogID_,BIGINT,:ProtocolVersion_,BIGINT,:Uin_,BIGINT,:IfSuccess_,BIGINT,:Device_,BIGINT,:ClientVersion_,BIGINT,:ClientIP_,BIGINT,:AgentIP_,BIGINT,:TimeStamp_,BIGINT,:ExpandCol1_,BIGINT,:ExpandCol2_,BIGINT,:GameID_,STRING,:GameVer_,BIGINT,:OP_,BIGINT,:BizUin_,BIGINT,:RedirectUrl_,STRING,
table.field.splitter=,
table.list.splitter=;
table.map.splitter=:
table.zk.servers=tl-zk-wx1:2181,tl-zk-wx2:2181,tl-zk-wx3:2181,tl-zk-wx4:2181,tl-zk-wx5:2181
table.zk.root=/meta_weixin
table.topic=wxg_weixin_msg_oauth
table.interfaceId=10528


[tabledesc-log-10978]
table.name=log_10978
table.binary.mode=false
table.fields=LogID_,BIGINT,:ProtocolVersion_,BIGINT,:Uin_,BIGINT,:IfSuccess_,BIGINT,:Device_,BIGINT,:ClientVersion_,BIGINT,:ClientIP_,BIGINT,:AgentIP_,BIGINT,:TimeStamp_,BIGINT,:ExpandCol1_,BIGINT,:ExpandCol2_,BIGINT,:UserUin_,BIGINT,:UUID_,STRING,:ScopeList_,STRING,:Action_,STRING,:appid_,STRING,:appname_,STRING,:redirecturl_,STRING,
table.field.splitter=,
table.list.splitter=;
table.map.splitter=:
table.zk.servers=tl-zk-wx1:2181,tl-zk-wx2:2181,tl-zk-wx3:2181,tl-zk-wx4:2181,tl-zk-wx5:2181
table.zk.root=/meta_weixin
table.topic=wxg_weixin_msg_oauth
table.interfaceId=10978

