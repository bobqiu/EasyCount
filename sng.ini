[system]
sql=with \
(select dwFromUin uin, (case when cType=0 or cType=2 or cType=16 then 0 when cType=3 or cType=4 then 1 \
when cType=5 then 2 when cType=7 then 3 else -1 end) ct, dwToUin touin, dwReqTime from tbl_100016) firsttbl \
\
insert into sng_jiahaoyou_hbase with concat_ws("-", uin, cast(dwReqTime as string), cast(ct as string)) as key \
select concat_ws("-", uin, cast(dwReqTime as string), cast(ct as string)) uinkey, map("touin", touin) from firsttbl \
\
insert into __printtable select "firsttbl", count(1) from firsttbl \
\
with \
(select 10000 + (AGGRTIME DIV 1000) % 90000 as tick from __innertable(100)) timetick, \
\
(select tick from timetick group by tick \
coordinate by unix_timestamp() with aggr interval 1 seconds) ticker, \
(select split("-", sng_jiahaoyou_hbase.rowkey) uinkey, map_get(sng_jiahaoyou_hbase.resdata, "touin") touin from ticker \
left join sng_jiahaoyou_hbase on concat(ticker.tick,"$") = sng_jiahaoyou_hbase.rowkey) updateinfo, \
(select array_get(uinkey, 0) newuin, array_get(uinkey, 1) dataTime, array_get(uinkey, 2) type, touin, unix_timestamp() gtime from updateinfo) tmpinfo \
\
insert into tde_res with newuin as key select newuin, from_unixtime(AGGRTIME DIV 1000, "yyyyMMdd") day, \
count(if(type=0, touin, null)), size(collect_set(if(type=0, touin, null))), \
count(if(type=1, touin, null)), size(collect_set(if(type=1, touin, null))), \
count(if(type=2, touin, null)), size(collect_set(if(type=2, touin, null))), \
count(if(type=3, touin, null)), size(collect_set(if(type=3, touin, null))) from tmpinfo where dataTime>gtime-30*24*60*60L \
group by newuin, gtime coordinate by gtime with aggr interval 60 seconds \
insert into __printtable select "tmpinfo", count(1) from tmpinfo



sql1= \
\
(select uin, max(inserttime) inserttime from tbl_trigger group by uin coordinate by unix_timestamp()*1000 with aggr interval 300 seconds) triggered, \
(select uin, dwReqTime inserttime from firsttbl union all select uin, inserttime from triggered where inserttime<unix_timestamp()) tobeupdate, \
(select tobeupdate.uin uin, tobeupdate.inserttime inserttime, split("-", sng_jiahaoyou_hbase.rowkey) uinkey, map_get(sng_jiahaoyou_hbase.resdata, "touin") touin from tobeupdate \
left join sng_jiahaoyou_hbase on concat(tobeupdate.uin,"$") = sng_jiahaoyou_hbase.rowkey) updateinfo, \
(select uin, array_get(uinkey, 1) dataTime, array_get(uinkey, 2) type, touin, unix_timestamp() gtime from updateinfo) tmpinfo \
\
insert into tbl_trigger select uin, unix_timestamp()+6L*60*60 from firsttbl, \
insert into tbl_trigger select uin, inserttime from triggered where inserttime>unix_timestamp(), \
insert into tde_res with uin as key select uin, from_unixtime(AGGRTIME DIV 1000, "yyyyMMdd") day, \
count(if(type=0, touin, null)), size(collect_set(if(type=0, touin, null))), \
count(if(type=1, touin, null)), size(collect_set(if(type=1, touin, null))), \
count(if(type=2, touin, null)), size(collect_set(if(type=2, touin, null))), \
count(if(type=3, touin, null)), size(collect_set(if(type=3, touin, null))) from tmpinfo where dataTime>gtime-30*24*60*60L \
group by uin, gtime coordinate by gtime with aggr interval 60 seconds


[tabledesc-tbl_100016]
table.name=tbl_100016
table.fields=cPkgType,STRING,:dwFromUin,string,:dwReqTime,BIGINT,:dwFromIP,BIGINT,:dwLoginTime,BIGINT,:cAddType,STRING,:\
wVersion,STRING,:cNeedRefuse,STRING,:wCmd,BIGINT,:dwToUin,string,:cType,STRING,:dwUinFlag,BIGINT,:wSrcID,BIGINT,:wSrcSubID,BIGINT,:\
dwModelFlag,BIGINT,:cWhiteFlag,STRING,:wModelID,BIGINT,:dwAddSvrIP,BIGINT,:cServiceType,STRING,:szMsgBuf,STRING

table.zk.servers=tl-zk-td1:2181,tl-zk-td2:2181,tl-zk-td3:2181,tl-zk-td4:2181,tl-zk-td5:2181
table.zk.root=/meta_vip
table.topic=sng_im_business_security
table.interfaceId=100016
table.field.splitter=;



[tabledesc-tbl_trigger]
table.name=tbl_trigger
table.fields=uin,string,:inserttime,bigint,:dTime,bigint,
table.zk.servers=tl-zk-td1:2181,tl-zk-td2:2181,tl-zk-td3:2181,tl-zk-td4:2181,tl-zk-td5:2181
table.zk.root=/meta_vip
table.topic=test
table.interfaceId=tbl_trigger
table.field.splitter=|



[tabledesc-dim-dim_hbase]
table.type=hbase
table.name=sng_jiahaoyou_hbase
table.fields=rowkey,string,:resdata,map<string\\,string>,
table.field.key=uin
table.binary.mode=false

table.hbase.zk.quorum=10.136.149.99,10.136.149.100,10.136.149.101
table.hbase.zk.port=8081
table.hbase.zk.root=/hbasetest2
table.hbase.read.async=false
table.hbase.write.async=true

[tabledesc-dim-tde_res]
table.type=tde
table.name=tde_res
table.fields=uin,string,:day,string,:cnt0,int,:uins0,int,:cnt1,int,:uins1,int,:cnt2,int,:uins2,int,:cnt3,int,:uins3,int,
table.field.key=uin
table.binary.mode=false

table.field.splitter=,
table.list.splitter=;
table.map.splitter=:

table.tde.master=10.208.146.154:5198
table.tde.slave=10.208.146.172:5198
table.tde.groupname=comm_gk_tdengine
table.tde.tid=1003
table.tde.timeout=5000








