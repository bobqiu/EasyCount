[system]
sql=WITH \ 
(SELECT qq_no,book_id bookid,0 readpv,pay_price salecount,  \
case when (src_type = 'wap' or src_type = 'ubook') then 'page' else 'app' end platform, \
substr(pay_time,0,19) dtEventTime  \
from qqread_qqbook_dsl_YbPay_fdt0  \
UNION ALL select qq_no,bookid,0 readpv,p_consume_price salecount , \
case when plaform_channel ='android' then 'app' when plaform_channel ='wap' or plaform_channel='ubook' then 'page' else "null" end platform , \
substr(buy_time,0,19) dtEventTime from qqread_qqbook_dsl_CloudPay_fdt0  \
where plaform_channel ='android' or plaform_channel='wap' or plaform_channel='ubook' \
union all \
select qq_no,bookid,1 readpv,0 salecount \
,if(plaform_channel = 'wap' or plaform_channel = 'ubook','page' ,'app') platform \
,regexp_extract(read_time,'^([0-9]{4}-[0-9]{2}-[0-9]{2}\\s[0-9]{2}:[0-9]{2}:[0-9]{2})$',1) dtEventTime \
from  qqread_qqbook_dsl_UserRead_fdt0 \
) parseTbl, \
(SELECT platform,bookid, from_unixtime((AGGRTIME DIV 1000), 'yyyy-MM-dd 00:00:00') timeD, \ 
concat(date_add('2014-06-08' ,(weekofyear(from_unixtime((AGGRTIME DIV 1000), 'yyyy-MM-dd'))-24)*7+1),' 00:00:00') timeW, \ 
from_unixtime((AGGRTIME DIV 1000), 'yyyy-MM-00 00:00:00') timeM, \
concat_ws('-', 'd', from_unixtime((AGGRTIME DIV 1000), 'yyyy-MM-dd 00:00:00'), platform, cast(bookid as string)) kd, \ 
concat_ws('-', 'w', concat(date_add('2014-06-08' ,(weekofyear(from_unixtime((AGGRTIME DIV 1000), 'yyyy-MM-dd'))-24)*7+1),' 00:00:00'),platform,cast(bookid as string)) kw, \
concat_ws('-', 'm', from_unixtime((AGGRTIME DIV 1000), 'yyyy-MM-00 00:00:00'), platform,cast(bookid as string)) km, \ 
sum(readpv) pv, hllp(qq_no) uvb, sum(salecount) salecount ,from_unixtime(unix_timestamp()) ts \ 
FROM parseTbl GROUP BY platform,bookid \ 
COORDINATE BY unix_timestamp(dtEventTime, 'yyyy-MM-dd HH:mm:ss')*1000 WITH AGGR INTERVAL 900 SECONDS) aggrTbl, \ 
\
(SELECT aggrTbl.kd, timeD statTime, aggrTbl.platform, aggrTbl.bookid, (aggrTbl.pv + nvl(booktmp.pv, 0L)) pv, \ 
hllp_merge(aggrTbl.uvb, booktmp.uvb) uvball, (aggrTbl.salecount + nvl(booktmp.salecount, 0L)) salecount, aggrTbl.ts \  
FROM aggrTbl left join booktmp on aggrTbl.kd=booktmp.k) jd,   \
\
(SELECT aggrTbl.kw, timeW statTime, aggrTbl.platform, aggrTbl.bookid, (aggrTbl.pv + nvl(booktmp.pv, 0L)) pv, \ 
hllp_merge(aggrTbl.uvb, booktmp.uvb) uvball, (aggrTbl.salecount + nvl(booktmp.salecount, 0L)) salecount, aggrTbl.ts \  
FROM aggrTbl left join booktmp on aggrTbl.kw=booktmp.k) jw,   \
\
(SELECT aggrTbl.km, timeM statTime, aggrTbl.platform, aggrTbl.bookid, (aggrTbl.pv + nvl(booktmp.pv, 0L)) pv, \ 
hllp_merge(aggrTbl.uvb, booktmp.uvb) uvball, (aggrTbl.salecount + nvl(booktmp.salecount, 0L)) salecount, aggrTbl.ts \  
FROM aggrTbl left join booktmp on aggrTbl.km=booktmp.k) jm,   \ 
\
(SELECT k, pv, uvball,salecount FROM \ 
(SELECT kd k, pv, uvball, salecount FROM jd \
UNION ALL \ 
SELECT kw k, pv, uvball,salecount FROM jw \
UNION ALL \ 
SELECT km k, pv, uvball,salecount FROM jm \
) jhd_utmp) jdwm  \
\
INSERT INTO booktmp WITH k as KEY SELECT k, pv, uvball , salecount FROM jdwm, \ 
INSERT INTO t_rst_com_qqbook_day SELECT statTime, platform, bookid,  pv, hllp_get(uvball), salecount, ts FROM jd , \ 
INSERT INTO t_rst_com_qqbook_week SELECT statTime, platform, bookid,  pv, hllp_get(uvball), salecount, ts FROM jw , \
INSERT INTO t_rst_com_qqbook_month SELECT statTime, platform, bookid,  pv, hllp_get(uvball), salecount, ts FROM jm  




[tabledesc-2]
table.name = qqread_qqbook_dsl_CloudPay_fdt0
table.fields = buy_time,STRING,:j4log,STRING,:operate_method,STRING,:operate_num,STRING,:qq_no,BIGINT,:bookid,BIGINT,:consume_price,BIGINT,:cp_id,BIGINT,:\
book_name,STRING,:pay_type,BIGINT,:user_status,BIGINT,:chapter_id,STRING,:valid_word_num,BIGINT,:price_per_thous,BIGINT,:price_per_book,BIGINT,:\
price_per_pack,BIGINT,:book_store,BIGINT,:inner_channel,STRING,:outer_channel,STRING,:plaform_channel,STRING,:cdf,STRING,:column_id,STRING,:sub_platform,STRING,:\
p_consume_price,BIGINT
table.type = stream
table.zk.servers = ? tl-xxx-xxx:2181  --Tdbank\ufffd\ufffd\ufffd\ufffdzkserver  \ufffd\ufffd\ufffd\ufffd\ufffd\u05aa\ufffd\ufffd
table.zk.root = /meta  ---zkroot \ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\u0434\ufffd\ufffd
table.topic = b_ieg_qqread_qqbook     --topic   \ufffd\ufffd\ufffd\u00f5\ufffd\u04b5\ufffd\ufffdID
table.interfaceId = CloudPay   --\ufffd\u04ff\ufffd\ufffd\ufffd
table.field.splitter = |

[tabledesc-3]
table.name = qqread_qqbook_dsl_YbPay_fdt0
table.fields = cid,BIGINT,:pay_time,STRING,:log_type,STRING,:qq_no,BIGINT,:book_id,BIGINT,:pay_price,BIGINT,:cp_id,BIGINT,:book_name,STRING,:pay_type,BIGINT,:user_status,BIGINT,:chapter_no,STRING,:valid_word,BIGINT,:word_price,BIGINT,:all_price,BIGINT,:merge_price,BIGINT,:book_db,BIGINT,:in_channel,BIGINT,:ou_channel,BIGINT,:src_type,STRING
table.zk.servers = xxx-xx-xxx1:2181,xxx-xx-xxx2:2181,xxx-xx-xxx3:2181,xxx-xx-xxx4:2181,xxx-xx-xxx5:2181
table.zk.root = /xxxx
table.topic = xxxx
table.interfaceId = xxxx
table.field.splitter = |

[tabledesc-4]
table.name = qqread_qqbook_dsl_UserRead_fdt0
table.fields = read_time,STRING,:platform,STRING,:qq_no,BIGINT,:bookid,BIGINT
table.type = stream
table.zk.servers = xxx-xx-xxx1:2181,xxx-xx-xxx2:2181,xxx-xx-xxx3:2181,xxx-xx-xxx4:2181,xxx-xx-xxx5:2181
table.zk.root = /xxxx
table.topic = xxxx
table.interfaceId = xxxx
table.field.splitter = |

[tabledesc-dimtable-tde]
table.type = tde
table.name = booktmp
table.fields = k,string,:pv,bigint,:uvb,binary,:salecount,bigint
table.field.key = k
table.binary.mode = true
table.tde.read.async = true
table.tde.write.async = false
table.tde.master = xx.xxx.xxx.xxx:xxxx
table.tde.slave = xx.xxx.xxx.xxx:xxxx
table.tde.groupname = xxxx
table.tde.tid = xxx
table.tde.timeout = 5000

[tabledesc-2-res1-t_rst_com_qqbook_day]
table.name = t_rst_com_qqbook_day
table.fields = statTime,string,:platform,string,:bookid,bigint,:pv,bigint,:uv,bigint,:salecount,bigint,:ts,string
table.type = mysql
table.mysql.db.host = 10.194.1.101
table.mysql.db.port = 3306
table.mysql.db.name = sortlist
table.mysql.db.username = bangdan
table.mysql.db.passwd = bangdanDB2014

[tabledesc-3-res2-t_rst_com_qqbook_week]
table.name = t_rst_com_qqbook_week
table.fields = statTime,string,:platform,string,:bookid,bigint,:pv,bigint,:uv,bigint,:salecount,bigint,:ts,string
table.type = mysql
table.mysql.db.host = 10.194.1.101
table.mysql.db.port = 3306
table.mysql.db.name = sortlist
table.mysql.db.username = bangdan
table.mysql.db.passwd = bangdanDB2014

[tabledesc-4-res3-t_rst_com_qqbook_month]
table.name = t_rst_com_qqbook_month
table.fields = statTime,string,:platform,string,:bookid,bigint,:pv,bigint,:uv,bigint,:salecount,bigint,:ts,string
table.type = mysql
table.mysql.db.host = 10.194.1.101
table.mysql.db.port = 3306
table.mysql.db.name = sortlist
table.mysql.db.username = bangdan
table.mysql.db.passwd = bangdanDB2014


