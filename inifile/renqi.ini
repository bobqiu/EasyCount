[system]
sql =  WITH (select qq_no,bookid,readpv, addfavor,delfavor,ticket_num,fans,platform,dtEventTime from( select qq_no,bookid,0L readpv,1L addfavor,0L delfavor,0L ticket_num,0L fans,'page' platform ,regexp_extract(act_time, '^([0-9]{4}-[0-9]{2}-[0-9]{2}\\\\s[0-9]{2}:[0-9]{2}:[0-9]{2})$',1) dtEventTime from qqread_qqbook_dsl_Favor_fdt0 where regexp_extract(act_time, '^(.*)(add)(.*)$',2)='add' union all select qq_no,bookid,0L readpv,0L addfavor,1L delfavor,0L ticket_num,0L fans,'page' platform ,regexp_extract(act_time, '^([0-9]{4}-[0-9]{2}-[0-9]{2}\\\\s[0-9]{2}:[0-9]{2}:[0-9]{2})$',1) dtEventTime from qqread_qqbook_dsl_Favor_fdt0 where regexp_extract(act_time, '^(.*)(add)(.*)$',2)='remove' union all select qq_no,bookid,0L readpv,1L addfavor,0L delfavor,0L ticket_num,0L fans,'app' platform ,regexp_extract(act_time, '^([0-9]{4}-[0-9]{2}-[0-9]{2}\\\\s[0-9]{2}:[0-9]{2}:[0-9]{2})$',1) dtEventTime from qqread_qqbook_dsl_Favor_fdt0 where regexp_extract(act_time, '^(.*)(add)(.*)$',2)='add' union all select qq_no,bookid,0L readpv,0L addfavor,1L delfavor,0L ticket_num,0L fans,'app' platform ,regexp_extract(act_time, '^([0-9]{4}-[0-9]{2}-[0-9]{2}\\\\s[0-9]{2}:[0-9]{2}:[0-9]{2})$',1) dtEventTime from qqread_qqbook_dsl_Favor_fdt0 where regexp_extract(act_time, '^(.*)(add)(.*)$',2)='remove' union all select regexp_extract(act_time, '^(.*)(INFO)(\\s+)(\\d+)$',4) qq_no,bookid,0L readpv,0L addfavor,0L delfavor, ticket_num,0L fans,'page' platform ,regexp_extract(act_time, '^([0-9]{4}-[0-9]{2}-[0-9]{2}\\\\s[0-9]{2}:[0-9]{2}:[0-9]{2})$',1) dtEventTime from qqread_qqbook_dsl_TjTicket_fdt0 union all select regexp_extract(act_time, '^(.*)(INFO)(\\s+)(\\d+)$',4) qq_no,bookid,0L readpv,0L addfavor,0L delfavor, ticket_num,0L fans,'app' platform ,regexp_extract(act_time, '^([0-9]{4}-[0-9]{2}-[0-9]{2}\\\\s[0-9]{2}:[0-9]{2}:[0-9]{2})$',1) dtEventTime from qqread_qqbook_dsl_TjTicket_fdt0 union all select qq_no,bookid,0L readpv,0L addfavor,0L delfavor, 0L ticket_num,1L fans,'page' platform ,regexp_extract(act_time, '^([0-9]{4}-[0-9]{2}-[0-9]{2}\\\\s[0-9]{2}:[0-9]{2}:[0-9]{2})$',1) dtEventTime from qqread_qqbook_dsl_Fans_fdt0 union all select qq_no,bookid,0L readpv,0L addfavor,0L delfavor, 0L ticket_num,1L fans,'app' platform ,regexp_extract(act_time, '^([0-9]{4}-[0-9]{2}-[0-9]{2}\\\\s[0-9]{2}:[0-9]{2}:[0-9]{2})$',1) dtEventTime from qqread_qqbook_dsl_Fans_fdt0 union all select qq_no,bookid,1L readpv,0L addfavor,0L delfavor, 0L ticket_num,0L fans ,case when (platform = 'wap' or platform = 'ubook') then 'page' else 'app' end platform ,regexp_extract(read_time, '^([0-9]{4}-[0-9]{2}-[0-9]{2}\\\\s[0-9]{2}:[0-9]{2}:[0-9]{2})$',1) dtEventTime from  qqread_qqbook_dsl_UserRead_fdt0 where qq_no>=10000\t)t) parseTbl,  (SELECT platform, bookid, concat(date_add('2014-06-08', (weekofyear(from_unixtime((AGGRTIME DIV 1000), 'yyyy-MM-dd'))-24)*7+1),' 00:00:00') timeW, from_unixtime((AGGRTIME DIV 1000), 'yyyy-MM-00 00:00:00') timeM, concat_ws('-', 'w', concat(date_add('2014-06-08' ,(weekofyear(from_unixtime((AGGRTIME DIV 1000), 'yyyy-MM-dd'))-24)*7+1),' 00:00:00'),platform,cast (bookid as string)) kw, concat_ws('-', 'm', from_unixtime((AGGRTIME DIV 1000), 'yyyy-MM-00 00:00:00'), platform, cast (bookid as string)) km, hllp(case when readpv>0 then qq_no end) uvb,sum(addfavor) addfavor,sum(delfavor) delfavor,sum(ticket_num) ticket, sum(fans) fans, from_unixtime(unix_timestamp()) ts FROM parseTbl GROUP BY platform,bookid COORDINATE BY unix_timestamp(dtEventTime, 'yyyy-MM-dd HH:mm:ss')*1000 WITH AGGR INTERVAL 900 SECONDS) aggrTbl,   (SELECT aggrTbl.kw, timeW statTime, aggrTbl.platform, aggrTbl.bookid, hllp_merge(aggrTbl.uvb, bookrenqi.uvball) uvball, (aggrTbl.addfavor + nvl(bookrenqi.addfavor, 0L)) addfavor, (aggrTbl.delfavor + nvl(bookrenqi.delfavor, 0L)) delfavor, (aggrTbl.ticket + nvl(bookrenqi.ticket, 0L)) ticket, (aggrTbl.fans + nvl(bookrenqi.fans, 0L)) fans , aggrTbl.ts FROM aggrTbl left join bookrenqi on aggrTbl.kw=bookrenqi.k) jw,  (SELECT aggrTbl.km, timeM statTime, aggrTbl.platform, aggrTbl.bookid, hllp_merge(aggrTbl.uvb, bookrenqi.uvball) uvball, (aggrTbl.addfavor + nvl(bookrenqi.addfavor, 0L)) addfavor, (aggrTbl.delfavor + nvl(bookrenqi.delfavor, 0L)) delfavor, (aggrTbl.ticket + nvl(bookrenqi.ticket, 0L)) ticket, (aggrTbl.fans + nvl(bookrenqi.fans, 0L)) fans , aggrTbl.ts FROM aggrTbl left join bookrenqi on aggrTbl.km=bookrenqi.k) jm,  (SELECT k, uvball,addfavor,delfavor,ticket,fans FROM ( SELECT kw k, uvball,addfavor,delfavor,ticket,fans FROM jw UNION ALL SELECT km k, uvball,addfavor,delfavor,ticket,fans FROM jm ) jhd_utmp) jwm  INSERT INTO bookrenqi WITH k as KEY SELECT k, uvball,addfavor,delfavor,ticket,fans FROM jwm, INSERT INTO t_rst_qqbook_renqi_week SELECT statTime, platform, bookid,   hllp_get(uvball), (addfavor-delfavor) favor,ticket,fans,(hllp_get(uvball)+ (addfavor-delfavor)+ticket+fans) renqi,ts FROM jw , INSERT INTO t_rst_qqbook_renqi_month SELECT statTime, platform, bookid,   hllp_get(uvball),(addfavor-delfavor)  favor,ticket,fans,(hllp_get(uvball)+ (addfavor-delfavor)+ticket+fans) renqi, ts FROM jm 


[tabledesc-1-Favor]
table.name = qqread_qqbook_dsl_Favor_fdt0
table.fields = act_time,STRING,:qq_no,BIGINT,:bookid,BIGINT,:platform,STRING
table.type = stream
table.zk.servers = tl-zk-td1:2181,tl-zk-td2:2181,tl-zk-td3:2181,tl-zk-td4:2181,tl-zk-td5:2181
table.zk.root = /meta_vip
table.topic = ieg_qqread_qqbook
table.interfaceId = Favor
table.field.splitter = |

[tabledesc-2-TjTicket]
table.name = qqread_qqbook_dsl_TjTicket_fdt0
table.fields = act_time,STRING,:data_type,STRING,:ticket_num,BIGINT,:bookid,BIGINT,:platform,STRING
table.zk.servers = tl-zk-td1:2181,tl-zk-td2:2181,tl-zk-td3:2181,tl-zk-td4:2181,tl-zk-td5:2181
table.zk.root = /meta_vip
table.topic = ieg_qqread_qqbook
table.interfaceId = TjTicket
table.field.splitter = |

[tabledesc-3-Fans]
table.name = qqread_qqbook_dsl_Fans_fdt0
table.fields = act_time,STRING,:data_type,BIGINT,:qq_no,BIGINT,:bookid,BIGINT,:prop_number,BIGINT,:add_fans_num,BIGINT,:current_lfas_num,BIGINT,:fans_level,BIGINT,:channel,BIGINT,:
table.zk.servers = tl-zk-td1:2181,tl-zk-td2:2181,tl-zk-td3:2181,tl-zk-td4:2181,tl-zk-td5:2181
table.zk.root = /meta_vip
table.topic = ieg_qqread_qqbook
table.interfaceId = Fans
table.field.splitter = |

[tabledesc-4-UserRead]
table.name = qqread_qqbook_dsl_UserRead_fdt0
table.fields = read_time,STRING,:platform,STRING,:qq_no,BIGINT,:bookid,BIGINT
table.type = stream
table.zk.servers = tl-zk-td1:2181,tl-zk-td2:2181,tl-zk-td3:2181,tl-zk-td4:2181,tl-zk-td5:2181
table.zk.root = /meta_vip
table.topic = ieg_qqread_qqbook
table.interfaceId = UserRead
table.field.splitter = |

[tabledesc-dimtable-tde]
table.type = tde
table.name = bookrenqi
table.fields = k,string,:uvball,binary,:addfavor,bigint,:delfavor,bigint,:ticket,bigint,:fans,bigint
table.field.key = k
table.binary.mode = true
table.tde.read.async = true
table.tde.write.async = true
table.tde.master = 10.208.146.154:5198
table.tde.slave = 10.208.146.172:5198
table.tde.groupname = comm_gk_tdengine
table.tde.tid = 1006
table.tde.timeout = 5000

[tabledesc-2-res2-t_rst_qqbook_renqi_week]
table.name = t_rst_qqbook_renqi_week
table.fields = statTime,string,:platform,string,:bookid,bigint,:uv,bigint,:favor,bigint,:tjticket,bigint,:fans,bigint,:renqi,bigint,:ts,string
table.type = mysql
table.mysql.db.host = 10.194.1.101
table.mysql.db.port = 3306
table.mysql.db.name = sortlist
table.mysql.db.username = bangdan
table.mysql.db.passwd = bangdanDB2014

[tabledesc-3-res3-t_rst_qqbook_renqi_month]
table.name = t_rst_qqbook_renqi_month
table.fields = statTime,string,:platform,string,:bookid,bigint,:uv,bigint,:favor,bigint,:tjticket,bigint,:fans,bigint,:renqi,bigint,:ts,string
table.type = mysql
table.mysql.db.host = 10.194.1.101
table.mysql.db.port = 3306
table.mysql.db.name = sortlist
table.mysql.db.username = bangdan
table.mysql.db.passwd = bangdanDB2014


