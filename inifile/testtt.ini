[system]
sql=\
WITH \
(SELECT concat_ws("_", accessId, account) uin, token device_id FROM src_tmp) tmp1, \
(SELECT uin, EXECUTE(\
	DEFINE seq AS string default "", seq_array AS array<string>, idx AS int default 0\
	{\
		$seq := cast(tmp1.device_id as string);\
		IF(\
			mta_id_to_mid.`data` IS NOT NULL \
			$seq_array := split(map_get(mta_id_to_mid.`data`, "mid"), ";");\
			FOR(\
				$idx < size($seq_array) \
				IF(\
					tmp1.device_id != array_get($seq_array, $idx) \
					$seq := concat_ws(";", $seq, array_get($seq_array, $idx))\
				);\
				$idx := $idx + 1\
			)\
		)\
	}\
	EMIT $seq\
) seq FROM tmp1 LEFT JOIN mta_id_to_mid ON tmp1.uin = mta_id_to_mid.rowkey) tmp2, \
(select cast(from_unixtime((AGGRTIME DIV 1000), "yyyyMMdd") as int) sdate, cast((AGGRTIME DIV 1000) as int) stime, accessId access_id, count(1) cnt from src_tmp group by accessId coordinate by src_tmp.`timestamp`*1000 with aggr interval 60 seconds) mon \
\
insert into __printtable select sdate, stime, access_id, cnt from mon, \
insert into xg_msdk_monitor select sdate, stime, access_id, cnt from mon, \
\
INSERT INTO __printtable SELECT "hbase_seq_print", uin, seq from tmp2, \
INSERT INTO mta_id_to_mid SELECT uin, map("mid", seq) FROM tmp2 

[tabledesc-src]
table.name=src_tmp
table.type=tube
table.binary.mode=false
table.fields=accessId,STRING,:account,STRING,msdk:token,STRING,:bindtype,STRING,:timestamp,BIGINT,
table.field.splitter=0x9
table.tube.master=tl-normal-tube-master
table.tube.port=8609
table.topic=teg_mta_xg_msdk
table.interfaceId=MSDKBindInfo

[tabledesc-hbase]
table.name=mta_id_to_mid
table.type=hbase
table.fields=rowkey,string,:data,map<string\\,string>,
table.field.splitter=,
table.map.splitter=:
table.hbase.zk.quorum=tl-hbase-zk-1,tl-hbase-zk-2,tl-hbase-zk-3,tl-hbase-zk-4,tl-hbase-zk-5
table.hbase.zk.port=2181
table.hbase.zk.root=/hbase_tmem
table.hbase.read.async=false

[tabledesc-dest]
table.name=xg_msdk_monitor
table.fields=sdate,int,:stime,int,:access_id,bigint,:record_count,int,
table.type=mysql
table.mysql.db.host=172.27.27.73
table.mysql.db.port=3306
table.mysql.db.name=muserportrait
table.mysql.db.username=root
table.mysql.db.passwd=



