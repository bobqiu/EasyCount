[system]


sql=with \
( \
	select \
		cast(rand()*100+10000 as string) as dwFromUin, \
		cast(rand()*10 as string) as cType, \
		cast(rand()*100+10000 as string) as dwToUin, \
		unix_timestamp() as dwReqTime \
	from __innertable(100) \
) tbl_100016_rand, \
( \
	select \
		cast(rand()*100+10000 as string) as uin, \
		unix_timestamp() as inserttime, \
		unix_timestamp()*1000 as dTime \
	from __innertable(10000) \
) tbl_trigger_rand, \
\
(select dwFromUin uin, (case when cType=0 or cType=2 or cType=16 then 0 when cType=3 or cType=4 then 1 \
when cType=5 then 2 when cType=7 then 3 else -1 end) ct, dwToUin touin, dwReqTime from tbl_100016_rand) firsttbl, \
\
(select 0 tag, uin, sum(if(ct=0,1,0)) cnt0, collect_set(if(ct=0,touin,null)) uins0, \
sum(if(ct=1,1,0)) cnt1, collect_set(if(ct=1,touin,null)) uins1, \
sum(if(ct=2,1,0)) cnt2, collect_set(if(ct=2,touin,null)) uins2, \
sum(if(ct=3,1,0)) cnt3, collect_set(if(ct=3,touin,null)) uins3, \
from_unixtime(AGGRTIME DIV 1000, "yyyyMMdd") day, AGGRTIME agtime \
from firsttbl group by uin coordinate by dwReqTime*1000 with aggr interval 60 seconds) sectbl, \
\
(select 1 tag, uin, 0 cnt0, array('') uins0, \
0 cnt1, array('') uins1, \
0 cnt2, array('') uins2, \
0 cnt3, array('') uins3, \
from_unixtime(AGGRTIME DIV 1000, "yyyyMMdd") day, max(inserttime) maxitime, AGGRTIME agtime \
from tbl_trigger_rand group by uin coordinate by dTime with aggr interval 3600 seconds) triggertbl, \
\
(select tag, uin, cast (cnt0 as int) cnt0, uins0, cast (cnt1 as int) cnt1, uins1, cast (cnt2 as int) cnt2, \
uins2, cast (cnt3 as int) cnt3, uins3, day, agtime from sectbl \
union all select tag, uin, cnt0, uins0, cnt1, uins1, cnt2, uins2, cnt3, uins3, day, agtime \
from triggertbl where agtime+3600000L-maxitime>6*3600*1000L) uniontmp, \
\
(select tag, uin, cnt0, uins0, cnt1, uins1, cnt2, uins2, cnt3, uins3, day, agtime, map_get(dim.resdata, day) cdaydimuins, \
dim.resdata dimuinall from uniontmp left join sng_jiahaoyou_hbase dim on uniontmp.uin=dim.uin) jointbl, \
\
(select tag, uin, day, struct(\
cnt0+coalesce(struct_get(cdaydimuins, 0), 0), \
array_merge(uins0, struct_get(cdaydimuins, 1)), \
cnt1+coalesce(struct_get(cdaydimuins, 2), 0), \
array_merge(uins1, struct_get(cdaydimuins, 3)), \
cnt2+coalesce(struct_get(cdaydimuins, 4), 0), \
array_merge(uins2, struct_get(cdaydimuins, 5)), \
cnt3+coalesce(struct_get(cdaydimuins, 6),0), \
array_merge(uins3, struct_get(cdaydimuins, 7)) \
) cdaydimuins, dimuinall from jointbl) combinetbl, \
\
(select tag, uin, day, cdaydimuins, map_struct(map_put(dimuinall, day, cdaydimuins)) dimuinall from combinetbl) mergetbl \
\
insert into sng_jiahaoyou_hbase with uin as key select uin, map(day, cdaydimuins) from mergetbl, \
\
insert into tde_res with uin as key select uin, day, \
execute(define c0 as int default 0, c1 as int default 0, c2 as int default 0, c3 as int default 0, \
cu0 as array<string>, cu1 as array<string>, cu2 as array<string>, cu3 as array<string>, x as int default 0 \
{for($x<size(dimuinall) \
if(unix_timestamp()-unix_timestamp(struct_get(array_get(dimuinall, $x), 0), 'yyyyMMdd')<=30*24*60*60L \
$c0:=$c0+struct_get(struct_get(array_get(dimuinall, $x), 1), 0);\
$c1:=$c1+struct_get(struct_get(array_get(dimuinall, $x), 1), 2);\
$c2:=$c2+struct_get(struct_get(array_get(dimuinall, $x), 1), 4);\
$c3:=$c3+struct_get(struct_get(array_get(dimuinall, $x), 1), 6);\
$cu0:=array_merge($cu0, struct_get(struct_get(array_get(dimuinall, $x), 1), 1));\
$cu1:=array_merge($cu1, struct_get(struct_get(array_get(dimuinall, $x), 1), 3));\
$cu2:=array_merge($cu2, struct_get(struct_get(array_get(dimuinall, $x), 1), 5));\
$cu3:=array_merge($cu3, struct_get(struct_get(array_get(dimuinall, $x), 1), 7))); x:=$x+1)} \
emit struct($c0, size($cu0), $c1, size($cu1), $c2, size($cu2), $c3, size($cu3)) ) numres from mergetbl, \
\
insert into __printtable select uin, inserttime, unix_timestamp()*1000+30*60*1000L dTime from (select uin, maxitime inserttime \
from triggertbl where agtime+3600000L-maxitime>=6*3600*1000L union all select uin, unix_timestamp() inserttime from sectbl) tmp


[tabledesc-tbl_100016]
table.name=tbl_100016
table.fields=cPkgType,STRING,:dwFromUin,string,:dwReqTime,BIGINT,:dwFromIP,BIGINT,:dwLoginTime,BIGINT,:cAddType,STRING,:\
wVersion,STRING,:cNeedRefuse,STRING,:wCmd,BIGINT,:dwToUin,string,:cType,STRING,:dwUinFlag,BIGINT,:wSrcID,BIGINT,:wSrcSubID,BIGINT,:\
dwModelFlag,BIGINT,:cWhiteFlag,STRING,:wModelID,BIGINT,:dwAddSvrIP,BIGINT,:cServiceType,STRING,:szMsgBuf,STRING

table.zk.servers=tl-zk-td1:2181,tl-zk-td2:2181,tl-zk-td3:2181,tl-zk-td4:2181,tl-zk-td5:2181
table.zk.root=/meta_vip
table.topic=sng_im_business_security
table.interfaceId=100016
table.field.splitter=;



[tabledesc-tbl_trigger]
table.name=tbl_trigger
table.fields=uin,string,:inserttime,bigint,:dTime,bigint,
table.zk.servers=tl-zk-td1:2181,tl-zk-td2:2181,tl-zk-td3:2181,tl-zk-td4:2181,tl-zk-td5:2181
table.zk.root=/meta_vip
table.topic=test
table.interfaceId=tbl_trigger
table.field.splitter=|



[tabledesc-dim-dim_hbase]
table.type=redis
table.name=sng_jiahaoyou_hbase
table.fields=uin,string,:resdata,map<string\\,struct<cnt0\\:int\\,uins0\\:array<string>\\,\
cnt1\\:int\\,uins1\\:array<string>\\,cnt2\\:int\\,uins2\\:array<string>\\,cnt3\\:int\\,uins3\\:array<string>>>,
table.field.key=uin
table.binary.mode=false

table.hbase.zk.quorum=10.136.149.99,10.136.149.100,10.136.149.101
table.hbase.zk.port=8081
table.hbase.zk.root=/hbasetest2
table.hbase.read.async=true

table.redis.host=127.0.0.1
table.redis.port=6379


[tabledesc-dim-tde_res]
table.type=redis
table.name=tde_res
table.fields=uin,string,:day,string,:numres,struct<cnt0\\:int\\,uins0\\:int\\,\
cnt1\\:int\\,uins1\\:int\\,cnt2\\:int\\,uins2\\:int\\,cnt3\\:int\\,uins3\\:int>,
table.field.key=k
table.binary.mode=true

table.field.splitter=,
table.list.splitter=;
table.map.splitter=:

table.tde.master=10.208.146.154:5198
table.tde.slave=10.208.146.172:5198
table.tde.groupname=comm_gk_tdengine
table.tde.tid=1003
table.tde.timeout=5000

table.redis.host=127.0.0.1
table.redis.port=6379







