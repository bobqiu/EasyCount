[system]
sql=with \
(select count, qq, cast (oid as string) oid, cast (lid as string) lid, cast (country as string) country, cast (gender as string) gender, \
cast (age as string) age, cast (scene as string) scene, time*1000 atime from gp_input) tbl, \
(select concat_ws("-", "0", oid, lid, "all", from_unixtime(AGGRTIME DIV 1000, "yyyyMMdd")) k, sum(count) cnt, hllp(qq) b, AGGRTIME agtime \
from tbl group by oid, lid coordinate by atime with aggr interval 20 seconds) aggr0, \
(select concat_ws("-", "1", oid, lid, country, from_unixtime(AGGRTIME DIV 1000, "yyyyMMdd")) k, sum(count) cnt, hllp(qq) b, AGGRTIME agtime \
from tbl group by oid, lid, country coordinate by atime with aggr interval 20 seconds) aggr1, \
(select concat_ws("-", "2", oid, lid, gender, from_unixtime(AGGRTIME DIV 1000, "yyyyMMdd")) k, sum(count) cnt, hllp(qq) b, AGGRTIME agtime \
from tbl group by oid, lid, gender coordinate by atime with aggr interval 20 seconds) aggr2, \
(select concat_ws("-", "3", oid, lid, age, from_unixtime(AGGRTIME DIV 1000, "yyyyMMdd")) k, sum(count) cnt, hllp(qq) b, AGGRTIME agtime \
from tbl group by oid, lid, age coordinate by atime with aggr interval 20 seconds) aggr3, \
(select concat_ws("-", "4", oid, lid, scene, from_unixtime(AGGRTIME DIV 1000, "yyyyMMdd")) k, sum(count) cnt, hllp(qq) b, AGGRTIME agtime \
from tbl group by oid, lid, scene coordinate by atime with aggr interval 20 seconds) aggr4, \
(select k, cnt, b, agtime from (select k, cnt, b, agtime from aggr0 union all select k, cnt, b, agtime from aggr1 union all \
select k, cnt, b, agtime from aggr2 union all select k, cnt, b, agtime from aggr3 union all select k, cnt, b, agtime from aggr4) xxxxtmp) uniontbl, \
(select uniontbl.k k, (uniontbl.cnt + (case when dimtmp.allcnt is null then 0L else dimtmp.allcnt end)) allcnt, \
hllp_merge(uniontbl.b, dimtmp.b) ball, agtime from uniontbl left join dimtmp on uniontbl.k=dimtmp.k) jointbl, \
(select split(k, "-") ks, allcnt, hllp_get(ball) ucnt from jointbl) parsetbl, \
(select array_get(ks, 0) idx, array_get(ks, 1) oid, array_get(ks, 2) lid, array_get(ks, 3) dimv, array_get(ks, 4) agtime, allcnt, ucnt \
from parsetbl) parsetbl1 \
insert into dimtmp with k as KEY select k, allcnt, ball from jointbl, \
insert into dest select concat_ws("-", oid, lid, idx, from_unixtime(AGGRTIME DIV 1000, "yyyyMMdd")), mapmap(dimv, concat(allcnt, "-", ucnt)) \
from parsetbl1 group by oid, lid, idx coordinate by to_unix_timestamp(agtime, "yyyyMMdd")*1000 with aggr interval 20 seconds


[tabledesc-input]
table.name=gp_input
table.fields=_DC_VERSION_LEN,int,:count,int,:qq,int,:oid,int,:cid,int,:sid,int,:time,int,:gender,string,:age,int,:scene,string,:country,int,:province,int,:city,int,:lid,int,:attrnum,int,:attr1,int,:attr2,int,:attr3,int,:attr4,int,:attr5,int,:averid,int,:UiIp,int,:x1,string,:contentid,int,:vid,string,:adType,string,:tpIndex,int,:price,string,:platformid,int,:browserid,int,:appuser,string,:coverid,string,:soidIp,int,:url,string,:soidSrc,string,:r90,string,:realtime,int,:intendtime,int,:v,string,:openudid,string,:macaddress,string,:pf_code,int,:refluence,int,:tagid,string,:pctr,int,:gn,int,:gt,string,:location_l,string,:maxadtime,string,:dura,string,:vptag,string,:pingtime,int,
table.zk.servers=tl-zk-td1:2181,tl-zk-td2:2181,tl-zk-td3:2181,tl-zk-td4:2181,tl-zk-td5:2181
table.zk.root=/meta_vip
table.topic=omg_ad1
table.interfaceId=web_view
table.field.splitter=,

[tabledesc-1]
table.name=gp_input_test
table.fields=count,int,:qq,int,:oid,int,:lid,int,:country,int,:gender,int,:age,int,:scene,int,:time,bigint,
table.field.splitter=,
table.list.splitter=;
table.map.splitter=:

table.zk.servers=tl-zk-test1:2181,tl-zk-test2:2181,tl-zk-test3:2181,tl-zk-test4:2181,tl-zk-test5:2181
table.zk.root=/meta
table.topic=boss
table.interfaceId=1

[tabledesc-dimtable-tde]
table.type=tde
table.name=dimtmp
table.fields=k,string,:allcnt,bigint,:b,binary,
table.field.key=k
table.binary.mode=true

table.tde.master=10.224.152.35:5198
table.tde.slave=10.129.131.235:5198
table.tde.groupname=tde_test
table.tde.tid=900
table.tde.timeout=5000

[tabledesc-dimtable]
table.type=redis
table.name=dimtmp1
table.fields=k,string,:allcnt,bigint,:b,binary,
table.field.key=k
table.binary.mode=true

table.field.splitter=,
table.list.splitter=;
table.map.splitter=:

table.redis.host=127.0.0.1
table.redis.port=6379

[tabledesc-2]
table.name=dest
table.binary.mode=false
table.fields=k,string,:allcnt,bigint,:cd,bigint,
table.field.splitter=,
table.list.splitter=;
table.map.splitter=:

table.zk.servers=tl-zk-test1:2181,tl-zk-test2:2181,tl-zk-test3:2181,tl-zk-test4:2181,tl-zk-test5:2181
table.zk.root=/meta
table.topic=snglogserver
table.interfaceId=gp_web_view_res
table.field.splitter=|







